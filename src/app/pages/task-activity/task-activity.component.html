<ng-template #loadingRef>
  <custom-loading *ngIf="loading"></custom-loading>
</ng-template>

<ng-container *ngIf="activity$ | async as a; else loadingRef">
  <div
    style="
      height: 36em;
      display: grid;
      gap: 1.5em;
      overflow-y: scroll;
      border-top: 1px solid #ddd;
      padding: 1.5em;
    "
    infiniteScroll
    [infiniteScrollDistance]="1"
    [scrollWindow]="false"
    [infiniteScrollThrottle]="50"
    (scrolled)="nextPage()"
    *ngIf="a.length > 0; else loadingRef"
  >
    <ng-container
      [ngSwitch]="activity.activityType"
      *ngFor="let activity of a; let i = index"
    >
      <ng-container *ngSwitchCase="activityType.userTask">
        <custom-media
          *ngIf="{
            parentUserTaskActivity: getParentUserTaskActivity(a, i)
          } as x"
          glyphicon="user"
          [headerTitle]="
            getUserFullName(
              activityIdHasMultiInstanceBody(activity.activityId)
                ? activity.user
                : x.parentUserTaskActivity?.user || activity.user
            )
          "
          altHeaderTitle="{{ 'NO_ASSIGN_USER_TASK' | translate }}"
          headerSubTitle="{{
            activity.endTime || activity.startTime | date : 'short'
          }}"
        >
          <div
            *ngIf="
              activityIdHasMultiInstanceBody(activity.activityId);
              else currentTask
            "
            innerHTML="{{
              'END_ACTIVITY_FLOW'
                | translate
                  : {
                      activityName: activity.activityName
                    }
            }}"
          ></div>

          <ng-template #currentTask>
            <div
              *ngIf="x.parentUserTaskActivity; else parentTask"
              innerHTML="{{
                'ACTIVITY_MOVES_TO'
                  | translate
                    : {
                        parentActivityName:
                          x.parentUserTaskActivity.activityName,
                        activityName: activity.activityName
                      }
              }}"
            ></div>
          </ng-template>

          <ng-template #parentTask>
            {{ "START_ACTIVITY_EVENT_NAME" | translate }}
            <b>{{ activity.activityName }}</b>
          </ng-template>
        </custom-media>
      </ng-container>

      <ng-template
        *ngSwitchCase="activityType.endEvent"
        [ngTemplateOutlet]="endEventType"
      ></ng-template>
      <ng-template
        *ngSwitchCase="activityType.noneEndEvent"
        [ngTemplateOutlet]="endEventType"
      ></ng-template>
      <ng-template #endEventType>
        <custom-media
          [headerTitle]="activity.activityName"
          altHeaderTitle="{{ 'END_ACTIVITY_EVENT_NAME' | translate }}"
          glyphicon="log-out"
          headerSubTitle="{{ activity.startTime | date : 'short' }}"
        >
          <div
            [innerHTML]="
              'END_ACTIVITY_FLOW'
                | translate
                  : {
                      activityName: getSubProcessActivityName(activity)
                    }
            "
          ></div>
        </custom-media>
      </ng-template>

      <custom-media
        *ngSwitchCase="activityType.startEvent"
        [headerTitle]="activity.activityName"
        altHeaderTitle="{{ 'START_ACTIVITY_EVENT_NAME' | translate }}"
        glyphicon="log-in"
        headerSubTitle="{{ activity.startTime | date : 'short' }}"
      >
        <div
          [innerHTML]="
            'START_ACTIVITY_FLOW'
              | translate
                : {
                    activityName: getSubProcessActivityName(activity)
                  }
          "
        ></div>
      </custom-media>

      <custom-media
        *ngSwitchCase="activityType.serviceTask"
        altHeaderTitle="{{ 'SERVICE_ACTIVITY_EVENT_NAME' | translate }}"
        [headerTitle]="activity.activityName"
        glyphicon="cog"
        headerSubTitle="{{ activity.startTime | date : 'short' }}"
      >
      </custom-media>

      <custom-media
        *ngSwitchCase="activityType.businessRuleTask"
        altHeaderTitle="{{ 'BUSINESS_ACTIVITY_EVENT_NAME' | translate }}"
        [headerTitle]="activity.activityName"
        glyphicon="list-alt"
        headerSubTitle="{{ activity.startTime | date : 'short' }}"
      >
      </custom-media>
    </ng-container>
  </div>

  <ng-template *ngIf="loading" [ngTemplateOutlet]="loadingRef"></ng-template>
</ng-container>
